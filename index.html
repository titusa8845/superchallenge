<!DOCTYPE html>
<html lang="zh-TW" data-lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¶…ç´šå¤§æŒ‘æˆ° - Rhythm Sync System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');

        body {
            font-family: 'Inter', "Microsoft JhengHei", sans-serif;
            background-color: #09090b;
            color: white;
            user-select: none;
        }

        /* éŠæˆ²æ ¼å­æ¨£å¼ */
        .grid-item {
            transition: all 0.1s ease-out;
            border: 2px solid #27272a;
        }

        .grid-item.active {
            border-color: transparent;
            box-shadow: 0 0 50px rgba(220, 38, 38, 0.8);
            transform: scale(1.1);
            z-index: 20;
            outline: 8px solid #dc2626;
        }

        /* æ¨™é¡Œç¯€å¥å‹•ç•« */
        .title-beat {
            transform: scale(1.1);
            color: #dc2626;
            text-shadow: 0 0 20px rgba(220, 38, 38, 0.8);
        }

        /* åœ–ç‰‡åº«æ¨£å¼ */
        .tray-item {
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .tray-item:hover {
            transform: translateY(-5px);
            border-color: #52525b;
        }

        .tray-item.selected {
            border-color: #3b82f6;
            /* è—è‰²é¸ä¸­æ¡† */
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
            transform: scale(1.05);
        }

        /* æ²è»¸ç¾åŒ– */
        .custom-scrollbar::-webkit-scrollbar {
            height: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #18181b;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #3f3f46;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #52525b;
        }

        input[type="file"] {
            display: none;
        }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden">

    <!-- YouTube Loader -->
    <div id="youtube-loader" class="fixed top-0 left-0 w-full z-[100] transition-all duration-500 pointer-events-none">
        <div class="w-full h-1 bg-blue-600/30 overflow-hidden">
            <div class="w-full h-full bg-blue-500 animate-[loading-bar_1.5s_ease-in-out_infinite]"></div>
        </div>
        <div class="flex justify-center mt-2">
            <span id="youtube-loader-text"
                class="bg-black/80 text-blue-200 text-xs font-bold px-4 py-1.5 rounded-full border border-blue-500/30 shadow-lg tracking-widest flex items-center gap-2">
                <svg class="animate-spin h-3 w-3 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
                YOUTUBEå½±ç‰‡Wordonbeatè¼‰å…¥ä¸­
            </span>
        </div>
    </div>

    <!-- é ‚éƒ¨è³‡è¨Šåˆ— (æµ®å‹•) -->
    <div class="fixed top-0 left-0 w-full p-4 flex justify-between items-start z-[60] pointer-events-none">
        <div class="pointer-events-auto bg-black/30 backdrop-blur-md p-3 rounded-2xl border border-white/10 shadow-xl transition-all duration-500"
            id="header-panel">
            <div class="flex items-center gap-3">
                <h1 id="main-title"
                    class="text-2xl md:text-6xl font-black italic tracking-tighter text-white transition-all duration-300 drop-shadow-[0_0_15px_rgba(255,255,255,0.3)]">
                    è¶…ç´šå¤§æŒ‘æˆ°
                </h1>
                <button id="info-btn"
                    class="w-8 h-8 rounded-full border border-white/20 flex items-center justify-center text-zinc-400 hover:text-white hover:bg-white/10 transition-colors pointer-events-auto group relative"
                    title="ç©æ³•èªªæ˜">
                    <span class="font-serif font-black italic text-lg opacity-70 group-hover:opacity-100">i</span>
                </button>
                <button id="lang-toggle"
                    class="ml-4 px-3 py-1.5 rounded-lg bg-white/10 text-white/80 hover:text-white text-xs font-bold border border-white/20 hover:bg-white/20 transition-all"
                    title="Toggle Language">
                    <span id="lang-text">ä¸­æ–‡</span>
                </button>
            </div>
            <div class="flex items-baseline gap-2">
                <span class="text-sm font-bold text-zinc-400 italic tracking-widest">by å°è¬</span>
            </div>
        </div>

        <!-- å›åˆæŒ‡ç¤ºå™¨ -->
        <!-- å›åˆæŒ‡ç¤ºå™¨ -->
        <div id="round-indicators"
            class="pointer-events-auto flex gap-1 bg-black/30 backdrop-blur-md p-1.5 rounded-2xl border border-white/10 shadow-lg transition-all duration-500 scale-90 md:scale-100 origin-top-right">
            <button onclick="setRound(0)" id="round-btn-0"
                class="round-active w-8 h-8 md:w-10 md:h-10 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 text-white font-bold shadow-[0_0_15px_rgba(59,130,246,0.5)] scale-110 border border-white/20 text-xs md:text-sm">1</button>
            <button onclick="setRound(1)" id="round-btn-1"
                class="round-btn w-8 h-8 md:w-10 md:h-10 rounded-xl bg-zinc-800/50 text-zinc-400 font-bold hover:bg-zinc-700/80 transition-all border border-white/5 text-xs md:text-sm">2</button>
            <button onclick="setRound(2)" id="round-btn-2"
                class="round-btn w-8 h-8 md:w-10 md:h-10 rounded-xl bg-zinc-800/50 text-zinc-400 font-bold hover:bg-zinc-700/80 transition-all border border-white/5 text-xs md:text-sm">3</button>
            <button onclick="setRound(3)" id="round-btn-3"
                class="round-btn w-8 h-8 md:w-10 md:h-10 rounded-xl bg-zinc-800/50 text-zinc-400 font-bold hover:bg-zinc-700/80 transition-all border border-white/5 text-xs md:text-sm">4</button>
            <button onclick="setRound(4)" id="round-btn-4"
                class="round-btn w-8 h-8 md:w-10 md:h-10 rounded-xl bg-zinc-800/50 text-zinc-400 font-bold hover:bg-zinc-700/80 transition-all border border-white/5 text-xs md:text-sm">5</button>
        </div>
    </div>

    <!-- ä¸»éŠæˆ²å€ (å…¨è¢å¹• + æ¨¡å¼åˆ‡æ›) -->
    <div class="absolute inset-0 z-0 flex flex-col items-center justify-center transition-all duration-700 ease-[cubic-bezier(0.34,1.56,0.64,1)]"
        id="game-container">
        <div id="game-grid"
            class="grid grid-cols-2 grid-rows-4 md:grid-cols-4 md:grid-rows-2 gap-2 md:gap-4 p-2 md:p-4 transition-all duration-700 w-[95%] h-[60%] md:w-[75%] md:h-[55%]">
            <!-- æ ¼å­ç”± JS å‹•æ…‹ç”Ÿæˆ -->
        </div>
    </div>

    <!-- æ’­æ”¾æ§åˆ¶æŒ‰éˆ• (æ‡¸æµ®å³ä¸‹) -->
    <div class="fixed right-6 bottom-40 z-40 flex flex-col gap-3 transition-all duration-500" id="control-panel">
        <button id="play-btn" disabled
            class="w-20 h-20 bg-white/10 backdrop-blur-md rounded-full flex items-center justify-center border border-white/20 hover:scale-110 active:scale-95 transition-all text-white disabled:opacity-50 disabled:cursor-not-allowed group shadow-2xl">
            <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"
                fill="currentColor">
                <polygon points="5 3 19 12 5 21 5 3" />
            </svg>
            <svg id="pause-icon" class="hidden" xmlns="http://www.w3.org/2000/svg" width="32" height="32"
                viewBox="0 0 24 24" fill="currentColor">
                <rect x="6" y="4" width="4" height="16" />
                <rect x="14" y="4" width="4" height="16" />
            </svg>
            <div id="loading-spinner"
                class="hidden absolute inset-0 rounded-full border-2 border-t-red-500 border-r-transparent border-b-zinc-800 border-l-transparent animate-spin">
            </div>
        </button>
        <button id="reset-btn"
            class="w-12 h-12 bg-black/50 backdrop-blur rounded-full flex items-center justify-center border border-white/10 hover:bg-zinc-800 text-zinc-400 hover:text-white transition-colors shadow-lg">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
                <path d="M3 3v5h5" />
            </svg>
        </button>
    </div>

    <!-- åº•éƒ¨ç´ æåº«æŠ½å±œ (Fixed Drawer) -->
    <div id="bottom-drawer"
        class="fixed bottom-0 left-0 w-full bg-black/90 backdrop-blur-xl border-t border-white/10 flex flex-col shrink-0 z-50 transition-transform duration-500 ease-out translate-y-0 shadow-[0_-10px_40px_rgba(0,0,0,0.8)]">

        <!-- Drawer Toggle Handle -->
        <div class="absolute -top-6 left-1/2 -translate-x-1/2 w-32 h-6 bg-black/90 backdrop-blur-xl rounded-t-xl border-t border-l border-r border-white/10 flex items-center justify-center cursor-pointer hover:bg-zinc-800 transition-colors group"
            onclick="toggleDrawer()">
            <svg id="drawer-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                fill="none" stroke="currentColor" stroke-width="2"
                class="text-zinc-400 group-hover:text-white transition-transform duration-300">
                <polyline points="6 9 12 15 18 9" />
            </svg>
        </div>

        <!-- æ–‡å­—è¼¸å…¥é¢æ¿ -->
        <div class="px-4 py-3 border-b border-white/10 bg-black/50">
            <div class="flex flex-wrap gap-3 items-center">
                <span class="text-xs font-bold text-zinc-400 uppercase tracking-widest">æ–‡å­—:</span>
                <input type="text" id="text-input" placeholder="è¼¸å…¥æ–‡å­—..." maxlength="20"
                    class="bg-zinc-800 text-white text-xs px-2 py-1.5 rounded border border-zinc-600 focus:outline-none focus:border-blue-500 focus:bg-zinc-700 transition-colors">
                
                <div class="flex items-center gap-2 border-l border-white/10 pl-3">
                    <span class="text-xs text-zinc-400">å¤§å°:</span>
                    <input type="number" id="text-size" min="12" max="200" value="72"
                        class="bg-zinc-800 text-white text-xs px-2 py-1 rounded border border-zinc-600 focus:outline-none focus:border-blue-500 w-12 text-center transition-colors">
                </div>

                <div class="flex items-center gap-2 border-l border-white/10 pl-3">
                    <span class="text-xs text-zinc-400">è‰²å½©:</span>
                    <input type="color" id="text-color" value="#ffffff"
                        class="w-8 h-8 rounded cursor-pointer border border-zinc-600 transition-colors hover:border-blue-500">
                </div>

                <button onclick="addTextToTray()"
                    class="ml-2 px-3 py-1.5 rounded-lg bg-green-600/30 text-green-300 hover:bg-green-600 hover:text-white border border-green-500/50 transition-all flex items-center gap-2 hover:scale-105 active:scale-95 text-xs font-bold">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    åŠ å…¥
                </button>
            </div>
        </div>

        <div class="px-4 py-3 flex flex-wrap justify-between items-center border-b border-white/5 bg-white/5 gap-y-3">
            <div class="flex items-center gap-4 md:gap-6 flex-wrap">
                <!-- Spotlight Toggle Switch -->
                <label for="spotlight-toggle" class="flex items-center cursor-pointer relative group">
                    <input type="checkbox" id="spotlight-toggle" class="sr-only peer" checked>
                    <div
                        class="w-9 h-5 bg-zinc-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-800 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600">
                    </div>
                    <span
                        class="ml-2 text-xs font-bold text-zinc-400 uppercase tracking-widest peer-checked:text-white transition-colors group-hover:text-zinc-300">èšå…‰ç‡ˆ</span>
                </label>

                <!-- Playback Speed -->
                <div class="flex items-center gap-2 border-l border-white/10 pl-6">
                    <span class="text-xs font-bold text-zinc-400 uppercase tracking-widest">é€Ÿåº¦</span>
                    <select id="speed-select"
                        class="bg-zinc-800 text-zinc-300 text-xs font-mono border border-zinc-600 rounded px-2 py-0.5 focus:outline-none focus:border-blue-500 cursor-pointer hover:bg-zinc-700 transition-colors appearance-none text-center w-16">
                        <option value="0.25">0.25x</option>
                        <option value="0.5">0.5x</option>
                        <option value="0.75">0.75x</option>
                        <option value="1.0" selected>1.0x</option>
                        <option value="1.25">1.25x</option>
                        <option value="1.5">1.5x</option>
                        <option value="2.0">2.0x</option>
                    </select>
                </div>

                <!-- Theme Switcher -->
                <div class="flex items-center gap-2 border-l border-white/10 pl-6">
                    <span class="text-xs font-bold text-zinc-400 uppercase tracking-widest">ä¸»é¡Œ</span>
                    <select id="theme-select"
                        class="bg-zinc-800 text-zinc-300 text-xs font-mono border border-zinc-600 rounded px-2 py-0.5 focus:outline-none focus:border-blue-500 cursor-pointer hover:bg-zinc-700 transition-colors appearance-none text-center min-w-[4rem]">
                        <option value="dark" selected>æ·±è‰²</option>
                        <option value="light">æ·ºè‰²</option>
                        <option value="parchment">ç¾Šçš®ç´™</option>
                    </select>
                </div>
            </div>


            <!-- Randomize Button -->
            <button onclick="randomizeAllRounds()" id="randomize-btn"
                class="ml-3 px-3 py-1.5 rounded-lg bg-indigo-600/30 text-indigo-300 hover:bg-indigo-600 hover:text-white border border-indigo-500/50 transition-all flex items-center gap-2 hover:scale-105 active:scale-95 group text-xs font-bold"
                title="éš¨æ©Ÿå¡«æ»¿æ‰€æœ‰å›åˆ">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="group-hover:rotate-180 transition-transform duration-500">
                    <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
                    <path d="M16 8h.01"></path>
                    <path d="M8 8h.01"></path>
                    <path d="M8 16h.01"></path>
                    <path d="M16 16h.01"></path>
                    <path d="M12 12h.01"></path>
                </svg>
                <span class="hidden sm:inline">éš¨æ©Ÿéª°å­</span>
            </button>

            <!-- Clear Grid Button -->
            <button onclick="clearAllGridImages()" id="clear-grid-btn"
                class="ml-2 px-3 py-1.5 rounded-lg bg-red-600/20 text-red-400 hover:bg-red-600 hover:text-white border border-red-500/30 transition-all flex items-center gap-2 hover:scale-105 active:scale-95 group text-xs font-bold"
                title="æ¸…é™¤æ‰€æœ‰æ ¼å­åœ–ç‰‡">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    <line x1="10" y1="11" x2="10" y2="17"></line>
                    <line x1="14" y1="11" x2="14" y2="17"></line>
                </svg>
                <span class="hidden sm:inline">æ¸…é™¤æ ¼å­</span>
            </button>


            <div class="flex gap-3">
                <div
                    class="hidden md:flex text-[10px] text-zinc-500 font-mono items-center mr-2 border border-dashed border-zinc-700 px-2 rounded">
                    DRAG & DROP READY
                </div>
                <button onclick="document.getElementById('upload-input').click()"
                    class="text-xs bg-blue-600/20 hover:bg-blue-600/40 border border-blue-500/30 px-4 py-1.5 rounded-lg text-blue-200 transition-all flex items-center gap-2 hover:scale-105 active:scale-95">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="17 8 12 3 7 8" />
                        <line x1="12" y1="3" x2="12" y2="15" />
                    </svg>
                    ä¸Šå‚³
                </button>
                <button onclick="clearTraySelection()"
                    class="text-xs text-zinc-500 hover:text-white px-3 transition-colors">æ¸…é™¤é¸å–</button>
            </div>
            <input type="file" id="upload-input" multiple accept="image/*" class="hidden">
        </div>

        <div id="image-tray"
            class="h-32 w-full overflow-x-auto overflow-y-hidden p-4 flex gap-4 custom-scrollbar items-center bg-zinc-950/50 transition-colors">
            <div
                class="text-zinc-600 text-sm italic px-8 pointer-events-none select-none flex items-center gap-3 w-full justify-center opacity-50">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="1.5">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                    <polyline points="17 8 12 3 7 8" />
                    <line x1="12" y1="3" x2="12" y2="15" />
                </svg>
                æ‹–æ›³åœ–ç‰‡è‡³æ­¤è™•ï¼Œæˆ–é»æ“Šä¸Šå‚³æŒ‰éˆ•
            </div>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="info-modal"
        class="fixed inset-0 bg-black/80 z-[200] flex items-center justify-center opacity-0 pointer-events-none transition-all duration-300 backdrop-blur-sm">
        <div class="bg-zinc-900 border border-white/10 rounded-2xl p-6 md:p-8 max-w-lg w-[90%] relative shadow-2xl transform scale-95 transition-all duration-300"
            id="info-content">
            <button id="close-info-btn" class="absolute top-4 right-4 text-zinc-500 hover:text-white transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            <h2 class="text-2xl font-black italic text-white mb-6 border-b border-white/10 pb-4">ç©æ³•èªªæ˜</h2>
            <div class="space-y-4 text-zinc-300 text-sm md:text-base leading-relaxed">
                <p><strong class="text-blue-400">1. ä¸Šå‚³èˆ‡æº–å‚™ï¼š</strong> å°‡åœ–ç‰‡æ‹–æ›³è‡³ä¸‹æ–¹ç´ æåº«ï¼Œæˆ–é»æ“Šä¸Šå‚³æŒ‰éˆ•ã€‚</p>
                <p><strong class="text-green-400">2. å¡«å…¥æ ¼å­ï¼š</strong> é»æ“Šä¸‹æ–¹ç´ æé¸å–åœ–ç‰‡ï¼Œå†é»æ“Šä¸Šæ–¹æ ¼å­å¡«å…¥ã€‚</p>
                <p><strong class="text-pink-400">3. è·Ÿè‘—ç¯€å¥ï¼š</strong> è§€å¯Ÿç°è‰²èƒŒæ™¯çš„ç§»å‹•ï¼Œç•¶å®ƒç¶“éæ ¼å­æ™‚ï¼Œè©²æ ¼æœƒäº®èµ·ä¸¦ç¿»è½‰ã€‚</p>

                <hr class="border-white/10 my-4">

                <h3 class="text-lg font-bold text-white mb-2">é—œæ–¼æœ¬éŠæˆ²</h3>
                <ul class="list-disc pl-5 space-y-1 text-zinc-400 text-xs md:text-sm">
                    <li><strong class="text-zinc-300">å…è²¬è²æ˜ï¼š</strong>è«‹å’Œå¹³éµå®ˆéŠæˆ²è¦å‰‡ï¼Œä¸¦åœ¨é©ç•¶åœ°æ–¹é€²è¡Œã€‚</li>
                    <li><strong class="text-zinc-300">é–‹æºè³‡è¨Šï¼š</strong>æ­¤ç¶²é ç‚º HTML å…¬é–‹åŸå§‹ç¢¼å¯åƒè€ƒã€‚</li>
                    <li><strong class="text-zinc-300">è²éŸ³ä¾†æºï¼š</strong>YouTube å½±ç‰‡ <a
                            href="https://www.youtube.com/watch?v=XdwFDwEgn0c" target="_blank"
                            class="text-blue-400 hover:text-blue-300 underline">Wordonbeat</a>ã€‚</li>
                    <li><strong class="text-zinc-300">éš±ç§è²æ˜ï¼š</strong>åœ–ç‰‡åƒ…æš«å­˜æ–¼æ‚¨çš„ç€è¦½å™¨ (LocalStorage)ï¼Œä¸æœƒä¸Šå‚³è‡³ä»»ä½•é›²ç«¯ä¼ºæœå™¨ï¼Œäº¦ç„¡éœ€ç™»å…¥å³å¯ä½¿ç”¨ã€‚
                    </li>
                </ul>

                <div class="p-4 bg-white/5 rounded-xl border border-white/5 mt-4">
                    <p class="font-bold text-white mb-1">ğŸ”¥ æŒ‘æˆ°ï¼š</p>
                    <p>æŒ‰ä¸‹æ’­æ”¾ï¼Œè·Ÿè‘—ç¯€å¥å¤§è²å”¸å‡ºåœ–ç‰‡åç¨±ï¼Œçœ‹èª°èƒ½è·Ÿä¸Šï¼å¿«ä¾†è·Ÿä½ çš„æœ‹å‹è©¦è©¦çœ‹ï¼</p>
                </div>
            </div>
        </div>
    </div>

    <!-- YouTube éš±è—æ’­æ”¾å™¨ -->
    <div id="youtube-player" class="fixed opacity-0 pointer-events-none -z-50 w-1 h-1 bottom-0 left-0"></div>

    <style>
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            height: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.02);
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        @keyframes loading-bar {
            0% {
                transform: translateX(-100%);
            }

            50% {
                transform: translateX(0%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        .grid-item.active {
            border: 4px solid #ef4444 !important;
            box-shadow: 0 0 40px #ef4444, inset 0 0 20px #ef4444;
            transform: scale(1.05);
            z-index: 20;
        }

        /* Spotlight Effect (Optional: Whiten/Flash) */
        .spotlight-mode .grid-item.active {
            filter: brightness(1.8) contrast(1.1) sepia(0.2);
            box-shadow: 0 0 40px #ef4444, inset 0 0 50px rgba(255, 255, 255, 0.5);
        }

        /* 3D Flip Effect */
        .perspective-1000 {
            perspective: 1000px;
        }

        .transform-style-3d {
            transform-style: preserve-3d;
        }

        .backface-hidden {
            backface-visibility: hidden;
        }

        .rotate-y-180 {
            transform: rotateY(180deg);
        }

        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s cubic-bezier(0.4, 0.0, 0.2, 1);
            transform-style: preserve-3d;
        }

        .flip-card-front,
        .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 1rem;
            /* rounded-2xl */
            overflow: hidden;
        }

        .flip-card-back {
            transform: rotateY(180deg);
        }

        /* When 'flipped' class is present, rotate the inner container */
        .grid-item.flipped .flip-card-inner {
            transform: rotateY(180deg);
        }

        .tray-drag-over {
            background-color: rgba(59, 130, 246, 0.1) !important;
            border: 2px dashed rgba(59, 130, 246, 0.5);
            box-shadow: inset 0 0 20px rgba(59, 130, 246, 0.2);
        }

        /* Mode Styles managed via JS classes on container */
        .mode-standby #game-grid {
            width: 75%;
            height: 55%;
            transform: perspective(1000px) rotateX(2deg);
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        .mode-playing #game-grid {
            width: 95%;
            height: 90%;
            transform: perspective(1000px) rotateX(0deg);
            background: transparent;
            border: none;
            box-shadow: none;
        }

        .drawer-closed {
            transform: translateY(100%);
        }

        .drawer-open {
            transform: translateY(0%);
        }

        .flip-icon {
            transform: rotate(180deg);
        }

        /* --- THEMES --- */

        /* Light Theme */
        .theme-light {
            background-color: #f4f4f5;
            /* zinc-100 */
        }

        .theme-light #header-panel,
        .theme-light #round-indicators,
        .theme-light #bottom-drawer,
        /* Drawer */
        .theme-light .drawer-bg {
            background-color: rgba(255, 255, 255, 0.9);
            border-color: rgba(0, 0, 0, 0.1);
        }

        .theme-light #main-title {
            color: #18181b;
            /* zinc-900 */
            text-shadow: none;
        }

        .theme-light span,
        .theme-light button,
        .theme-light label {
            color: #27272a;
            /* zinc-800 */
        }

        .theme-light .flip-card-front,
        .theme-light .flip-card-back {
            background-color: #ffffff;
            border-color: #d4d4d8;
            /* zinc-300 */
        }

        .theme-light #drawer-icon {
            stroke: #52525b;
        }

        .theme-light .text-zinc-400 {
            color: #52525b;
        }

        .theme-light .text-zinc-500 {
            color: #52525b;
        }

        /* Fix dropdowns in light mode */
        .theme-light select {
            background-color: #ffffff;
            color: #18181b;
            border-color: #d4d4d8;
        }

        /* Parchment Theme */
        .theme-parchment {
            background-color: #f0e6d2;
            /* Warm Beige */
        }

        .theme-parchment #header-panel,
        .theme-parchment #round-indicators,
        .theme-parchment #bottom-drawer {
            background-color: rgba(230, 220, 195, 0.95);
            /* Darker Beige */
            border-color: #8c7b65;
            /* Warm Brown Border */
            box-shadow: 0 4px 6px -1px rgba(74, 59, 42, 0.1), 0 2px 4px -1px rgba(74, 59, 42, 0.06);
        }

        .theme-parchment #main-title {
            color: #4a3b2a;
            /* Dark Brown */
            text-shadow: 1px 1px 0px rgba(255, 255, 255, 0.5);
        }

        .theme-parchment span,
        .theme-parchment button,
        .theme-parchment label {
            color: #5c4d3c;
            /* Brown Text */
        }

        .theme-parchment .flip-card-front,
        .theme-parchment .flip-card-back {
            background-color: #f5f5dc;
            /* Cream */
            border-color: #a89f91;
            box-shadow: inset 0 0 20px rgba(139, 69, 19, 0.1);
        }

        .theme-parchment .grid-item.active {
            border-color: #8b4513 !important;
            /* Saddle Brown Highlight */
            box-shadow: 0 0 30px rgba(139, 69, 19, 0.6);
        }

        .theme-parchment #drawer-icon {
            stroke: #5c4d3c;
        }

        .theme-parchment .text-zinc-400 {
            color: #5c4d3c;
        }

        .theme-parchment .text-zinc-500 {
            color: #6d5e4d;
        }

        .theme-parchment select {
            background-color: #fefcf5;
            color: #4a3b2a;
            border-color: #8c7b65;
        }

        /* Modal Theme Overrides */
        .theme-light #info-content {
            background-color: #ffffff;
            border-color: #d4d4d8;
        }

        .theme-light #info-content h2,
        .theme-light #info-content p,
        .theme-light #info-content strong,
        .theme-light #info-content .text-zinc-300 {
            color: #27272a;
        }

        .theme-light #info-content .bg-white\/5 {
            background-color: #f4f4f5;
            border-color: #d4d4d8;
        }

        .theme-light #info-content .text-white {
            color: #18181b;
        }

        .theme-parchment #info-content {
            background-color: #f0e6d2;
            border-color: #8c7b65;
        }

        .theme-parchment #info-content h2,
        .theme-parchment #info-content p,
        .theme-parchment #info-content strong,
        .theme-parchment #info-content .text-zinc-300 {
            color: #4a3b2a;
        }

        .theme-parchment #info-content .bg-white\/5 {
            background-color: #e6dcc3;
            border-color: #8c7b65;
        }

        .theme-parchment #info-content .text-white {
            color: #4a3b2a;
        }

        /* --- SPOTLIGHT CONTRAST FIX --- */
        /* Override for Light/Parchment to prevent font washout */
        .theme-light.spotlight-mode .grid-item.active,
        .theme-parchment.spotlight-mode .grid-item.active {
            filter: none !important;
            /* Disable brightness filter */
            box-shadow: 0 0 30px #f59e0b, inset 0 0 30px rgba(245, 158, 11, 0.3) !important;
            /* Amber Glow */
            border-color: #f59e0b !important;
            transform: scale(1.08);
        }

        /* Ensure text remains dark in these modes */
        .theme-light.spotlight-mode .grid-item.active .text-white,
        .theme-parchment.spotlight-mode .grid-item.active .text-white {
            color: #18181b !important;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.9);
        }
    </style>

    <script>
        // === ç¿»è­¯ç³»çµ± ===
        const TRANSLATIONS = {
            zh: {
                title: 'è¶…ç´šå¤§æŒ‘æˆ°',
                info: 'ç©æ³•èªªæ˜',
                langText: 'ä¸­æ–‡',
                textLabel: 'æ–‡å­—:',
                textPlaceholder: 'è¼¸å…¥æ–‡å­—...',
                sizeLabel: 'å¤§å°:',
                colorLabel: 'è‰²å½©:',
                addBtn: 'åŠ å…¥',
                spotlight: 'èšå…‰ç‡ˆ',
                speed: 'é€Ÿåº¦',
                theme: 'ä¸»é¡Œ',
                randomize: 'éš¨æ©Ÿéª°å­',
                clearGrid: 'æ¸…é™¤æ ¼å­',
                upload: 'ä¸Šå‚³',
                clearSelection: 'æ¸…é™¤é¸å–',
                dragDropText: 'æ‹–æ›³åœ–ç‰‡è‡³æ­¤è™•ï¼Œæˆ–é»æ“Šä¸Šå‚³æŒ‰éˆ•',
                howToPlay: 'ç©æ³•èªªæ˜',
                upload2: 'å°‡åœ–ç‰‡æ‹–æ›³è‡³ä¸‹æ–¹ç´ æåº«ï¼Œæˆ–é»æ“Šä¸Šå‚³æŒ‰éˆ•ã€‚',
                fillSlots: 'é»æ“Šä¸‹æ–¹ç´ æé¸å–åœ–ç‰‡ï¼Œå†é»æ“Šä¸Šæ–¹æ ¼å­å¡«å…¥ã€‚',
                followRhythm: 'è§€å¯Ÿç°è‰²èƒŒæ™¯çš„ç§»å‹•ï¼Œç•¶å®ƒç¶“éæ ¼å­æ™‚ï¼Œè©²æ ¼æœƒäº®èµ·ä¸¦ç¿»è½‰ã€‚',
                about: 'é—œæ–¼æœ¬éŠæˆ²',
                disclaimer: 'è«‹å’Œå¹³éµå®ˆéŠæˆ²è¦å‰‡ï¼Œä¸¦åœ¨é©ç•¶åœ°æ–¹é€²è¡Œã€‚',
                opensource: 'æ­¤ç¶²é ç‚º HTML å…¬é–‹åŸå§‹ç¢¼å¯åƒè€ƒã€‚',
                soundSource: 'YouTube å½±ç‰‡',
                privacy: 'åœ–ç‰‡åƒ…æš«å­˜æ–¼æ‚¨çš„ç€è¦½å™¨ (LocalStorage)ï¼Œä¸æœƒä¸Šå‚³è‡³ä»»ä½•é›²ç«¯ä¼ºæœå™¨ï¼Œäº¦ç„¡éœ€ç™»å…¥å³å¯ä½¿ç”¨ã€‚',
                challenge: 'æŒ‘æˆ°ï¼š',
                challengeText: 'æŒ‰ä¸‹æ’­æ”¾ï¼Œè·Ÿè‘—ç¯€å¥å¤§è²å”¸å‡ºåœ–ç‰‡åç¨±ï¼Œçœ‹èª°èƒ½è·Ÿä¸Šï¼å¿«ä¾†è·Ÿä½ çš„æœ‹å‹è©¦è©¦çœ‹ï¼',
                deleteImage: 'åˆªé™¤åœ–ç‰‡',
                deleteText: 'åˆªé™¤æ–‡å­—',
                emptyTray: 'ç´ æåº«æ˜¯ç©ºçš„ï¼è«‹å…ˆä¸Šå‚³åœ–ç‰‡æˆ–è¼¸å…¥æ–‡å­—ã€‚',
                emptyText: 'è«‹è¼¸å…¥æ–‡å­—ï¼',
                darkTheme: 'æ·±è‰²',
                lightTheme: 'æ·ºè‰²',
                parchmentTheme: 'ç¾Šçš®ç´™',
                youtubeLoading: 'YOUTUBEå½±ç‰‡Wordonbeatè¼‰å…¥ä¸­',
                dragDropReady: 'DRAG & DROP READY'
            },
            en: {
                title: 'Super Challenge',
                info: 'How to Play',
                langText: 'English',
                textLabel: 'Text:',
                textPlaceholder: 'Enter text...',
                sizeLabel: 'Size:',
                colorLabel: 'Color:',
                addBtn: 'Add',
                spotlight: 'Spotlight',
                speed: 'Speed',
                theme: 'Theme',
                randomize: 'Randomize',
                clearGrid: 'Clear Grid',
                upload: 'Upload',
                clearSelection: 'Clear Selection',
                dragDropText: 'Drag images here, or click upload button',
                howToPlay: 'How to Play',
                upload2: 'Drag and drop images to the material library below, or click the upload button.',
                fillSlots: 'Click on the materials below to select an image, then click on the grid slots above to fill them.',
                followRhythm: 'Watch the gray background move. When it passes a grid slot, that slot will light up and flip.',
                about: 'About This Game',
                disclaimer: 'Please play fairly and follow the rules in appropriate settings.',
                opensource: 'This webpage is open source HTML that you can refer to.',
                soundSource: 'YouTube Video',
                privacy: 'Images are stored only in your browser (LocalStorage) and will not be uploaded to any cloud server. No login required.',
                challenge: 'Challenge:',
                challengeText: 'Press play and say the image names out loud following the rhythm. See who can keep up! Try it with your friends!',
                deleteImage: 'Delete Image',
                deleteText: 'Delete Text',
                emptyTray: 'Material library is empty! Please upload images or enter text first.',
                emptyText: 'Please enter text!',
                darkTheme: 'Dark',
                lightTheme: 'Light',
                parchmentTheme: 'Parchment',
                youtubeLoading: 'YouTube Video Wordonbeat Loading',
                dragDropReady: 'DRAG & DROP READY'
            }
        };

        let CURRENT_LANG = localStorage.getItem('gameLanguage') || 'zh';

        function t(key) {
            return TRANSLATIONS[CURRENT_LANG][key] || TRANSLATIONS['zh'][key] || key;
        }

        function setLanguage(lang) {
            CURRENT_LANG = lang;
            localStorage.setItem('gameLanguage', lang);
            document.documentElement.setAttribute('data-lang', lang);
            updateUIText();
        }

        function toggleLanguage() {
            const newLang = CURRENT_LANG === 'zh' ? 'en' : 'zh';
            setLanguage(newLang);
        }

        function updateUIText() {
            // æ¨™é¡Œ
            const title = document.getElementById('main-title');
            if (title) title.textContent = t('title');

            // Info button
            const infoBtn = document.getElementById('info-btn');
            if (infoBtn) infoBtn.title = t('info');

            // Language button
            const langText = document.getElementById('lang-text');
            if (langText) langText.textContent = t('langText');

            // YouTube loader
            const youtubeLoaderText = document.getElementById('youtube-loader-text');
            if (youtubeLoaderText) {
                const svg = youtubeLoaderText.querySelector('svg');
                youtubeLoaderText.innerHTML = `${svg.outerHTML}${t('youtubeLoading')}`;
            }

            // Text input
            const textInput = document.getElementById('text-input');
            if (textInput) textInput.placeholder = t('textPlaceholder');

            // Update all labels and buttons
            const allSpans = document.querySelectorAll('span');
            allSpans.forEach(span => {
                const text = span.textContent;
                if (text === 'æ–‡å­—:' || text === 'Text:') span.textContent = t('textLabel');
                if (text === 'å¤§å°:' || text === 'Size:') span.textContent = t('sizeLabel');
                if (text === 'è‰²å½©:' || text === 'Color:') span.textContent = t('colorLabel');
                if (text === 'èšå…‰ç‡ˆ' || text === 'Spotlight') span.textContent = t('spotlight');
                if (text === 'é€Ÿåº¦' || text === 'Speed') span.textContent = t('speed');
                if (text === 'ä¸»é¡Œ' || text === 'Theme') span.textContent = t('theme');
            });

            // Button texts
            const allButtons = document.querySelectorAll('button');
            allButtons.forEach(btn => {
                if (btn.textContent.includes('åŠ å…¥') || btn.textContent.includes('Add')) {
                    btn.textContent = t('addBtn');
                }
                if (btn.textContent.includes('éš¨æ©Ÿéª°å­') || btn.textContent.includes('Randomize')) {
                    btn.innerHTML = btn.innerHTML.replace(/éš¨æ©Ÿéª°å­|Randomize/, t('randomize'));
                }
                if (btn.textContent.includes('æ¸…é™¤æ ¼å­') || btn.textContent.includes('Clear Grid')) {
                    btn.innerHTML = btn.innerHTML.replace(/æ¸…é™¤æ ¼å­|Clear Grid/, t('clearGrid'));
                }
                if (btn.textContent.includes('ä¸Šå‚³') || btn.textContent.includes('Upload')) {
                    btn.innerHTML = btn.innerHTML.replace(/ä¸Šå‚³|Upload/, t('upload'));
                }
                if (btn.textContent === 'æ¸…é™¤é¸å–' || btn.textContent === 'Clear Selection') {
                    btn.textContent = t('clearSelection');
                }
            });

            // Selects
            const selects = document.querySelectorAll('select');
            selects.forEach(select => {
                if (select.id === 'theme-select') {
                    const options = select.querySelectorAll('option');
                    if (options.length >= 3) {
                        options[0].textContent = t('darkTheme');
                        options[1].textContent = t('lightTheme');
                        options[2].textContent = t('parchmentTheme');
                    }
                }
            });

            // Drag drop text
            const dragDropHint = document.querySelector('.text-zinc-600.italic');
            if (dragDropHint) dragDropHint.textContent = t('dragDropText');

            // Info modal
            const infoHeading = document.querySelector('h2.text-2xl.font-black.italic');
            if (infoHeading) infoHeading.textContent = t('howToPlay');

            // Info content
            const infoParagraphs = document.querySelectorAll('.space-y-4 > p, .space-y-4 > strong + p');
            const aboutH3 = document.querySelector('h3.text-lg.font-bold');
            if (aboutH3) aboutH3.textContent = t('about');
        }

        // Initialize language on page load
        document.getElementById('lang-toggle').addEventListener('click', toggleLanguage);
        setTimeout(updateUIText, 100);
    </script>

    <script>
        // --- æ ¸å¿ƒè¨­å®š ---
        let BPM = 174;
        let BEAT_DURATION = 60 / BPM;

        const TOTAL_ROUNDS = 5;
        const SLOTS_PER_ROUND = 8;

        const GAME_STATE = {
            currentRound: 0,
            rounds: Array.from({ length: TOTAL_ROUNDS }, () => ({
                content: Array(SLOTS_PER_ROUND).fill(null)  // æ”¹ç‚ºé€šç”¨çš„ contentï¼Œæ”¯æ´ {type: 'image'|'text', ...}
            })),
            activeTrayItem: null,  // æ”¹ç‚º activeTrayItemï¼Œæ”¯æ´åœ–ç‰‡æˆ–æ–‡å­—
            isPlaying: false,
            animationFrameId: null,
            lastBeat: -1,
            globalOffset: 0,
            isDrawerOpen: true
        };

        const RHYTHM_TIMELINE = [
            { time: 0.0, action: 'stop', round: 0 },
            { time: 5.2, action: 'start', round: 0 },
            { time: 10.5, action: 'start', round: 1 },
            { time: 15.8, action: 'start', round: 2 },
            { time: 21.0, action: 'start', round: 3 },
            { time: 26.3, action: 'start', round: 4 },
            { time: 999.0, action: 'stop' }
        ];

        // --- DOM Elements ---
        const gridEl = document.getElementById('game-grid');
        const gameContainer = document.getElementById('game-container');
        const trayEl = document.getElementById('image-tray');
        const uploadInput = document.getElementById('upload-input');
        const drawerEl = document.getElementById('bottom-drawer');
        const drawerIcon = document.getElementById('drawer-icon');
        const spotlightToggle = document.getElementById('spotlight-toggle');
        const speedSelect = document.getElementById('speed-select');
        const themeSelect = document.getElementById('theme-select');

        function init() {
            setupTrayEvents();
            updateRoundButtons();
            setGameMode('standby'); // default

            // Spotlight Toggle
            if (spotlightToggle) {
                spotlightToggle.addEventListener('change', (e) => {
                    toggleSpotlight(e.target.checked);
                    saveGameData();
                });
                toggleSpotlight(spotlightToggle.checked);
            }

            // Playback Speed
            if (speedSelect) {
                speedSelect.addEventListener('change', (e) => {
                    const rate = parseFloat(e.target.value);
                    if (player && player.setPlaybackRate) {
                        player.setPlaybackRate(rate);
                    }
                    saveGameData();
                });
            }

            // Theme Switcher
            if (themeSelect) {
                themeSelect.addEventListener('change', (e) => {
                    setTheme(e.target.value);
                });
            }

            // Info Modal Logic
            const infoBtn = document.getElementById('info-btn');
            const closeInfoBtn = document.getElementById('close-info-btn');
            const infoModal = document.getElementById('info-modal');

            if (infoBtn && infoModal) {
                infoBtn.addEventListener('click', () => {
                    infoModal.classList.remove('opacity-0', 'pointer-events-none');
                    const content = infoModal.querySelector('#info-content');
                    if (content) {
                        content.classList.remove('scale-95');
                        content.classList.add('scale-100');
                    }
                });
            }
            if (closeInfoBtn && infoModal) {
                closeInfoBtn.addEventListener('click', () => {
                    infoModal.classList.add('opacity-0', 'pointer-events-none');
                    const content = infoModal.querySelector('#info-content');
                    if (content) {
                        content.classList.add('scale-95');
                        content.classList.remove('scale-100');
                    }
                });
                infoModal.addEventListener('click', (e) => {
                    if (e.target === infoModal) {
                        closeInfoBtn.click();
                    }
                });
            }

            // Load Data FIRST (before setting default theme)
            loadGameData();

            // æœ€å¾Œæ‰æ¸²æŸ“æ ¼å­ï¼Œç¢ºä¿è³‡æ–™å·²è¼‰å…¥
            renderGrid();

            // Set default theme ONLY if no saved theme was loaded
            if (!localStorage.getItem('superChallengeData')) {
                setTheme('dark');
            }
        }

        // --- LocalStorage Functions ---
        function saveGameData() {
            try {
                const trayItems = [];
                document.querySelectorAll('#image-tray .tray-item').forEach(itemEl => {
                    const img = itemEl.querySelector('img');
                    if (img) {
                        trayItems.push({ type: 'image', value: img.src });
                    } else {
                        // å¾ data å±¬æ€§ä¸­è®€å–æ–‡å­—çš„å¤§å°å’Œé¡è‰²
                        const textSize = itemEl.getAttribute('data-text-size');
                        const textColor = itemEl.getAttribute('data-text-color');
                        if (textSize && textColor) {
                            trayItems.push({
                                type: 'text',
                                value: itemEl.querySelector('div').textContent,
                                size: parseInt(textSize),
                                color: textColor
                            });
                        }
                    }
                });

                const data = {
                    rounds: GAME_STATE.rounds,
                    trayItems: trayItems,
                    theme: document.body.classList.contains('theme-light') ? 'light' :
                        document.body.classList.contains('theme-parchment') ? 'parchment' : 'dark',
                    spotlight: spotlightToggle ? spotlightToggle.checked : true,
                    speed: speedSelect ? speedSelect.value : '1.0'
                };
                localStorage.setItem('superChallengeData', JSON.stringify(data));
            } catch (e) {
                console.warn('Failed to save game data:', e);
            }
        }

        function loadGameData() {
            try {
                const savedData = localStorage.getItem('superChallengeData');
                if (!savedData) return;

                const data = JSON.parse(savedData);

                // Restore rounds - with migration from old 'images' format
                if (data.rounds) {
                    // Migrate old format (images) to new format (content)
                    GAME_STATE.rounds = data.rounds.map(round => {
                        if (round.images && !round.content) {
                            // èˆŠæ ¼å¼è½‰æ›ç‚ºæ–°æ ¼å¼
                            return {
                                content: round.images.map(img => img ? { type: 'image', value: img } : null)
                            };
                        }
                        return round;
                    });
                }

                // Restore tray items
                if (data.trayItems && data.trayItems.length > 0) {
                    data.trayItems.forEach(item => {
                        if (item.type === 'image') {
                            addImageToTray(item.value, false);
                        } else if (item.type === 'text') {
                            // æš«æ™‚è¨­å®šè¼¸å…¥æ¡†çš„å€¼ï¼Œç„¶å¾Œå‘¼å« addTextToTray
                            document.getElementById('text-input').value = item.value;
                            document.getElementById('text-size').value = item.size || 24;
                            // ç¢ºä¿è‰²å½©æ ¼å¼ç‚º HEX
                            let color = item.color || '#ffffff';
                            color = rgbToHex(color);
                            document.getElementById('text-color').value = color;
                            addTextToTray();
                        }
                    });
                }

                // Restore theme
                if (data.theme && themeSelect) {
                    themeSelect.value = data.theme;
                    setTheme(data.theme);
                }

                // Restore spotlight
                if (typeof data.spotlight === 'boolean' && spotlightToggle) {
                    spotlightToggle.checked = data.spotlight;
                    toggleSpotlight(data.spotlight);
                }

                // Restore speed
                if (data.speed && speedSelect) {
                    speedSelect.value = data.speed;
                }
            } catch (e) {
                console.warn('Failed to load game data:', e);
            }
        }

        function setTheme(theme) {
            document.body.classList.remove('theme-light', 'theme-parchment');
            if (theme === 'light') {
                document.body.classList.add('theme-light');
            } else if (theme === 'parchment') {
                document.body.classList.add('theme-parchment');
            }
            // 'dark' is default (no class)
            saveGameData();
        }

        function toggleSpotlight(enabled) {
            if (enabled) {
                gridEl.classList.add('spotlight-mode');
            } else {
                gridEl.classList.remove('spotlight-mode');
            }
        }

        // --- View Mode & Drawer Logic ---
        function setGameMode(mode) {
            const header = document.getElementById('header-panel');
            const roundIndicators = document.getElementById('round-indicators');
            // const controls = document.getElementById('control-panel'); // Kept for reference

            if (mode === 'playing') {
                gameContainer.classList.remove('mode-standby');
                gameContainer.classList.add('mode-playing');
                toggleDrawer(false); // Auto close drawer

                // Visual tweaks for playing: HIDDEN
                header.classList.add('opacity-0', 'pointer-events-none', '-translate-y-10');
                roundIndicators.classList.add('opacity-0', 'pointer-events-none', '-translate-y-10');

            } else {
                gameContainer.classList.remove('mode-playing');
                gameContainer.classList.add('mode-standby');
                toggleDrawer(true); // Auto open drawer

                // Visual tweaks for standby: VISIBLE
                header.classList.remove('opacity-0', 'pointer-events-none', '-translate-y-10');
                roundIndicators.classList.remove('opacity-0', 'pointer-events-none', '-translate-y-10');
            }
        }

        function toggleDrawer(forceState = null) {
            const shouldOpen = forceState !== null ? forceState : !GAME_STATE.isDrawerOpen;
            GAME_STATE.isDrawerOpen = shouldOpen;

            if (shouldOpen) {
                drawerEl.classList.remove('drawer-closed');
                drawerIcon.classList.remove('flip-icon'); // arrow down
            } else {
                drawerEl.classList.add('drawer-closed');
                drawerIcon.classList.add('flip-icon'); // arrow up
            }
        }

        // --- UI Rendering ---
        function renderGrid() {
            gridEl.innerHTML = '';
            const content = GAME_STATE.rounds[GAME_STATE.currentRound].content;

            content.forEach((item, index) => {
                const slot = document.createElement('div');
                slot.id = `slot-${index}`;
                slot.className = `grid-item perspective-1000 w-full h-full relative group cursor-pointer`;

                const inner = document.createElement('div');
                inner.className = 'flip-card-inner w-full h-full shadow-inner rounded-2xl';

                // --- FRONT FACE ---
                const front = document.createElement('div');
                front.className = 'flip-card-front bg-zinc-800/80 flex items-center justify-center border-2 border-white/5';

                if (item) {
                    if (item.type === 'text') {
                        // æ¸²æŸ“æ–‡å­—
                        front.innerHTML = `
                            <div class="w-full h-full flex items-center justify-center p-4 text-center break-words" 
                                 style="color: ${item.color}; font-size: ${item.size}px; font-weight: bold; line-height: 1.2;">
                                ${item.value}
                            </div>
                            <div class="absolute inset-0 bg-black/0 group-hover:bg-white/10 transition-colors"></div>
                        `;
                    } else {
                        // æ¸²æŸ“åœ–ç‰‡
                        front.innerHTML = `<img src="${item.value}" class="w-full h-full object-contain group-hover:scale-105 transition-transform duration-500">
                                           <div class="absolute inset-0 bg-black/0 group-hover:bg-white/10 transition-colors"></div>`;
                    }
                } else {
                    front.innerHTML = `<span class="text-white/10 font-black text-6xl md:text-9xl select-none group-hover:text-white/20 transition-colors italic">#${index + 1}</span>`;
                }

                // --- BACK FACE ---
                const back = document.createElement('div');
                back.className = 'flip-card-back bg-zinc-800/80 flex items-center justify-center border-2 border-white/5';
                back.innerHTML = `<div class="w-full h-full bg-zinc-900 flex items-center justify-center"><span class="animate-pulse text-zinc-500">Loading...</span></div>`;

                inner.appendChild(front);
                inner.appendChild(back);
                slot.appendChild(inner);

                slot.onclick = () => handleSlotClick(index);
                gridEl.appendChild(slot);
            });
        }

        // Helper to update the "Back" face with the content of a specific round
        function prepareFlipContent(targetRoundIndex) {
            const nextContent = GAME_STATE.rounds[targetRoundIndex].content;
            const slots = document.querySelectorAll('.grid-item');

            slots.forEach((slot, index) => {
                const inner = slot.querySelector('.flip-card-inner');
                if (!inner) return;

                const isFlipped = slot.classList.contains('flipped');
                const targetFace = isFlipped ? inner.querySelector('.flip-card-front') : inner.querySelector('.flip-card-back');

                const item = nextContent[index];
                if (item) {
                    if (item.type === 'text') {
                        targetFace.innerHTML = `
                            <div class="w-full h-full flex items-center justify-center p-4 text-center break-words" 
                                 style="color: ${item.color}; font-size: ${item.size}px; font-weight: bold; line-height: 1.2;">
                                ${item.value}
                            </div>
                            <div class="absolute inset-0 bg-black/0 group-hover:bg-white/10 transition-colors"></div>
                        `;
                    } else {
                        targetFace.innerHTML = `<img src="${item.value}" class="w-full h-full object-cover">
                                                <div class="absolute inset-0 bg-black/0 group-hover:bg-white/10 transition-colors"></div>`;
                    }
                } else {
                    targetFace.innerHTML = `<span class="text-white/10 font-black text-6xl md:text-9xl select-none group-hover:text-white/20 transition-colors italic">#${index + 1}</span>`;
                }
            });
        }

        // Execute the flip animation
        function triggerFlip() {
            const slots = document.querySelectorAll('.grid-item');
            slots.forEach(slot => {
                slot.classList.toggle('flipped');
            });
        }

        function updateRoundButtons() {
            for (let i = 0; i < TOTAL_ROUNDS; i++) {
                const btn = document.getElementById(`round-btn-${i}`);
                if (i === GAME_STATE.currentRound) {
                    btn.className = 'round-btn w-8 h-8 md:w-10 md:h-10 rounded-xl bg-blue-600 text-white font-bold shadow-[0_0_20px_rgba(37,99,235,0.5)] scale-110 transition-all border border-blue-400 text-xs md:text-sm z-10';
                } else {
                    btn.className = 'round-btn w-8 h-8 md:w-10 md:h-10 rounded-xl bg-zinc-800/50 text-zinc-400 font-bold hover:bg-zinc-700/80 transition-all border border-white/5 text-xs md:text-sm hover:text-white';
                }
            }
        }

        function handleSlotClick(index) {
            const currentItem = GAME_STATE.rounds[GAME_STATE.currentRound].content[index];

            if (GAME_STATE.activeTrayItem) {
                // If tray has selection, ALWAYS overwrite (set content)
                GAME_STATE.rounds[GAME_STATE.currentRound].content[index] = GAME_STATE.activeTrayItem;
            } else if (currentItem) {
                // If NO tray selection but item exists, clear it (toggle off)
                GAME_STATE.rounds[GAME_STATE.currentRound].content[index] = null;
            }
            saveGameData();

            // Re-render logic that preserves flip state
            const slot = document.getElementById(`slot-${index}`);
            const isFlipped = slot.classList.contains('flipped');

            const inner = slot.querySelector('.flip-card-inner');
            const targetFace = isFlipped ? inner.querySelector('.flip-card-back') : inner.querySelector('.flip-card-front');
            const newItem = GAME_STATE.rounds[GAME_STATE.currentRound].content[index];

            if (newItem) {
                if (newItem.type === 'text') {
                    targetFace.innerHTML = `
                        <div class="w-full h-full flex items-center justify-center p-4 text-center break-words" 
                             style="color: ${newItem.color}; font-size: ${newItem.size}px; font-weight: bold; line-height: 1.2;">
                            ${newItem.value}
                        </div>
                        <div class="absolute inset-0 bg-black/0 group-hover:bg-white/10 transition-colors"></div>
                    `;
                } else {
                    targetFace.innerHTML = `<img src="${newItem.value}" class="w-full h-full object-contain group-hover:scale-105 transition-transform duration-500">
                                            <div class="absolute inset-0 bg-black/0 group-hover:bg-white/10 transition-colors"></div>`;
                }
            } else {
                targetFace.innerHTML = `<span class="text-white/10 font-black text-6xl md:text-9xl select-none group-hover:text-white/20 transition-colors italic">#${index + 1}</span>`;
            }
        }

        function setRound(roundIndex) {
            GAME_STATE.currentRound = roundIndex;
            updateRoundButtons();

            // Reset to Front view when manually changing rounds (to keep things simple)
            renderGrid(); // renderGrid creates fresh DOM, defaulting to Front

            updateRhythmEffect(-1);
            GAME_STATE.hasFlippedForThisRound = false;
        }

        // --- Image Tray Logic ---
        function setupTrayEvents() {
            trayEl.addEventListener('dragover', (e) => { e.preventDefault(); trayEl.classList.add('tray-drag-over'); });
            trayEl.addEventListener('dragleave', (e) => { e.preventDefault(); trayEl.classList.remove('tray-drag-over'); });
            trayEl.addEventListener('drop', (e) => {
                e.preventDefault();
                trayEl.classList.remove('tray-drag-over');
                handleFiles(e.dataTransfer.files);
            });
            uploadInput.addEventListener('change', (e) => { handleFiles(e.target.files); uploadInput.value = ''; });

            // æ–‡å­—è¼¸å…¥æ¡†å›è»Šæ”¯æ´
            const textInput = document.getElementById('text-input');
            if (textInput) {
                textInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') addTextToTray();
                });
            }

            // è‰²å½©å’Œå¤§å°å¯¦æ™‚é è¦½
            const colorInput = document.getElementById('text-color');
            const sizeInput = document.getElementById('text-size');
            if (colorInput) {
                colorInput.addEventListener('change', updatePreview);
                colorInput.addEventListener('input', updatePreview);
            }
            if (sizeInput) {
                sizeInput.addEventListener('change', updatePreview);
                sizeInput.addEventListener('input', updatePreview);
            }
        }

        function updatePreview() {
            const textInput = document.getElementById('text-input');
            const sizeInput = document.getElementById('text-size');
            const colorInput = document.getElementById('text-color');

            const text = textInput.value.trim();
            const size = parseInt(sizeInput.value) || 24;
            const color = colorInput.value;

            // æ›´æ–°è¼¸å…¥æ¡†çš„èƒŒæ™¯è‰²ä»¥ç¤ºæ„è‰²å½©é¸æ“‡
            colorInput.style.backgroundColor = color;
        }

        // RGB è½‰ HEX
        function rgbToHex(rgb) {
            if (rgb.startsWith('#')) return rgb;
            const result = rgb.match(/\d+/g);
            if (!result || result.length < 3) return '#ffffff';
            return "#" + result.slice(0, 3).map(x => {
                const hex = parseInt(x).toString(16);
                return hex.length === 1 ? "0" + hex : hex;
            }).join('');
        }

        function handleFiles(files) {
            if (!files.length) return;
            const hint = trayEl.querySelector('.italic');
            if (hint) hint.remove();

            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (evt) => addImageToTray(evt.target.result);
                    reader.readAsDataURL(file);
                }
            });
        }

        function addImageToTray(src, shouldSave = true) {
            // Remove hint if present
            const hint = trayEl.querySelector('.text-zinc-600');
            if (hint) hint.remove();

            const div = document.createElement('div');
            div.className = 'tray-item w-28 h-24 bg-zinc-800 rounded-xl shrink-0 cursor-pointer overflow-hidden relative border-2 border-transparent hover:border-zinc-500 transition-all group';

            // Image
            const img = document.createElement('img');
            img.src = src;
            img.className = 'w-full h-full object-contain group-hover:scale-110 transition-transform';
            div.appendChild(img);

            // Delete Button (X)
            const delBtn = document.createElement('button');
            delBtn.className = 'absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600 shadow-md z-20 hover:scale-110 active:scale-90';
            delBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;
            delBtn.title = 'åˆªé™¤åœ–ç‰‡';
            delBtn.onclick = (e) => {
                e.stopPropagation();
                div.remove();

                // If deleting active item, clear selection
                if (GAME_STATE.activeTrayItem && GAME_STATE.activeTrayItem.type === 'image' && GAME_STATE.activeTrayItem.value === src) {
                    GAME_STATE.activeTrayItem = null;
                }
                saveGameData();
            };
            div.appendChild(delBtn);

            // Selection Logic
            div.onclick = () => {
                const prev = trayEl.querySelector('.border-blue-500');
                if (prev) {
                    prev.classList.remove('border-blue-500', 'shadow-[0_0_20px_rgba(59,130,246,0.6)]', 'scale-105', 'z-10');
                    prev.classList.add('border-transparent');
                }
                const imageItem = { type: 'image', value: src };
                if (GAME_STATE.activeTrayItem && GAME_STATE.activeTrayItem.type === 'image' && GAME_STATE.activeTrayItem.value === src) {
                    GAME_STATE.activeTrayItem = null;
                } else {
                    div.classList.remove('border-transparent');
                    div.classList.add('border-blue-500', 'shadow-[0_0_20px_rgba(59,130,246,0.6)]', 'scale-105', 'z-10');
                    GAME_STATE.activeTrayItem = imageItem;
                }
            };
            trayEl.appendChild(div);
            if (shouldSave) saveGameData();
        }

        function addTextToTray() {
            const textInput = document.getElementById('text-input');
            const sizeInput = document.getElementById('text-size');
            const colorInput = document.getElementById('text-color');

            const text = textInput.value.trim();
            const size = parseInt(sizeInput.value) || 24;
            const color = colorInput.value;

            if (!text) {
                alert(t('emptyText'));
                return;
            }

            // Remove hint if present
            const hint = trayEl.querySelector('.text-zinc-600');
            if (hint) hint.remove();

            const div = document.createElement('div');
            div.className = 'tray-item w-28 h-24 bg-zinc-800 rounded-xl shrink-0 cursor-pointer overflow-hidden relative border-2 border-transparent hover:border-zinc-500 transition-all group flex items-center justify-center p-2';
            // åœ¨å®¹å™¨ä¸Šå„²å­˜åŸå§‹çš„å¤§å°å’Œé¡è‰²
            div.setAttribute('data-text-size', size);
            div.setAttribute('data-text-color', color);

            // æ–‡å­—é è¦½
            const textPreview = document.createElement('div');
            textPreview.className = 'w-full h-full flex items-center justify-center text-center break-words';
            textPreview.style.color = color;
            textPreview.style.fontSize = size + 'px';
            textPreview.style.fontWeight = 'bold';
            textPreview.style.lineHeight = '1.2';
            textPreview.textContent = text;
            div.appendChild(textPreview);

            // Delete Button (X)
            const delBtn = document.createElement('button');
            delBtn.className = 'absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600 shadow-md z-20 hover:scale-110 active:scale-90';
            delBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;
            delBtn.title = 'åˆªé™¤æ–‡å­—';
            delBtn.onclick = (e) => {
                e.stopPropagation();
                div.remove();

                // If deleting active item, clear selection
                if (GAME_STATE.activeTrayItem && GAME_STATE.activeTrayItem.type === 'text' && GAME_STATE.activeTrayItem.value === text) {
                    GAME_STATE.activeTrayItem = null;
                }
                saveGameData();
            };
            div.appendChild(delBtn);

            // Selection Logic
            div.onclick = () => {
                const prev = trayEl.querySelector('.border-blue-500');
                if (prev) {
                    prev.classList.remove('border-blue-500', 'shadow-[0_0_20px_rgba(59,130,246,0.6)]', 'scale-105', 'z-10');
                    prev.classList.add('border-transparent');
                }
                const textItem = { type: 'text', value: text, size: size, color: color };
                if (GAME_STATE.activeTrayItem && GAME_STATE.activeTrayItem.type === 'text' && GAME_STATE.activeTrayItem.value === text) {
                    GAME_STATE.activeTrayItem = null;
                } else {
                    div.classList.remove('border-transparent');
                    div.classList.add('border-blue-500', 'shadow-[0_0_20px_rgba(59,130,246,0.6)]', 'scale-105', 'z-10');
                    GAME_STATE.activeTrayItem = textItem;
                }
            };
            trayEl.appendChild(div);
            textInput.value = '';
            saveGameData();
        }

        function randomizeAllRounds() {
            const trayItems = [];
            document.querySelectorAll('#image-tray .tray-item').forEach(itemEl => {
                const img = itemEl.querySelector('img');
                if (img) {
                    // åœ–ç‰‡
                    trayItems.push({ type: 'image', value: img.src });
                } else {
                    // æ–‡å­— - å¾ data å±¬æ€§ä¸­è®€å–
                    const textSize = itemEl.getAttribute('data-text-size');
                    const textColor = itemEl.getAttribute('data-text-color');
                    if (textSize && textColor) {
                        trayItems.push({
                            type: 'text',
                            value: itemEl.querySelector('div').textContent,
                            size: parseInt(textSize),
                            color: textColor
                        });
                    }
                }
            });

            if (trayItems.length === 0) {
                alert(t('emptyTray'));
                return;
            }

            // Fill all rounds
            for (let r = 0; r < TOTAL_ROUNDS; r++) {
                for (let s = 0; s < SLOTS_PER_ROUND; s++) {
                    const randomItem = trayItems[Math.floor(Math.random() * trayItems.length)];
                    GAME_STATE.rounds[r].content[s] = randomItem;
                }
            }

            renderGrid();
            saveGameData();

            // Visual feedback
            const btn = document.getElementById('randomize-btn');
            if (btn) {
                btn.classList.add('animate-spin');
                setTimeout(() => btn.classList.remove('animate-spin'), 500);
            }
        }

        function clearAllGridImages() {
            // Clear all content in all rounds
            for (let r = 0; r < TOTAL_ROUNDS; r++) {
                for (let s = 0; s < SLOTS_PER_ROUND; s++) {
                    GAME_STATE.rounds[r].content[s] = null;
                }
            }

            renderGrid();
            saveGameData();
        }

        function clearTraySelection() {
            const prev = trayEl.querySelector('.border-blue-500');
            if (prev) {
                prev.classList.remove('border-blue-500', 'shadow-[0_0_20px_rgba(59,130,246,0.6)]', 'scale-105', 'z-10');
                prev.classList.add('border-transparent');
            }
            GAME_STATE.activeTrayItem = null;
        }

        // --- YouTube API ---
        let player;
        window.onYouTubeIframeAPIReady = function () {
            player = new YT.Player('youtube-player', {
                height: '100%', width: '100%', videoId: 'XdwFDwEgn0c',
                playerVars: { 'playsinline': 1, 'controls': 0, 'disablekb': 1 },
                events: { 'onReady': onPlayerReady, 'onStateChange': onPlayerStateChange }
            });
        };

        function onPlayerReady() {
            const playBtn = document.getElementById('play-btn');
            document.getElementById('loading-spinner').classList.add('hidden');
            // Hide Top Loader
            document.getElementById('youtube-loader').classList.add('opacity-0', '-translate-y-full');

            playBtn.disabled = false;
        }

        function onPlayerStateChange(event) {
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            const playBtn = document.getElementById('play-btn');
            const loader = document.getElementById('youtube-loader');

            // Handle Buffering
            if (event.data === YT.PlayerState.BUFFERING) {
                loader.classList.remove('opacity-0', '-translate-y-full');
            } else {
                loader.classList.add('opacity-0', '-translate-y-full');
            }

            if (event.data === YT.PlayerState.PLAYING) {
                GAME_STATE.isPlaying = true;
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
                playBtn.classList.add('border-red-500', 'bg-red-600/20', 'animate-pulse');
                setGameMode('playing');
                loop();
            } else {
                GAME_STATE.isPlaying = false;
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
                playBtn.classList.remove('border-red-500', 'bg-red-600/20', 'animate-pulse');

                // If stopped or paused, go back to standby
                if (event.data === YT.PlayerState.PAUSED || event.data === YT.PlayerState.ENDED || event.data === YT.PlayerState.CUED) {
                    setGameMode('standby');
                }

                if (GAME_STATE.animationFrameId) cancelAnimationFrame(GAME_STATE.animationFrameId);
            }
        }

        // --- Game Loop ---
        function loop() {
            if (!GAME_STATE.isPlaying) return;
            if (player && player.getCurrentTime) {
                let currentTime = player.getCurrentTime();
                const adjustedTime = currentTime - (GAME_STATE.globalOffset / 1000);
                updateGameLogic(adjustedTime < 0 ? 0 : adjustedTime);
                // document.getElementById('timer-display').innerText = `TIME: ${currentTime.toFixed(2)}s`;
            }
            GAME_STATE.animationFrameId = requestAnimationFrame(loop);
        }

        function updateGameLogic(time) {
            const title = document.getElementById('main-title');

            // æ‰¾å‡ºç›®å‰ç”Ÿæ•ˆçš„æ™‚é–“å€æ®µ
            const currentEvent = [...RHYTHM_TIMELINE].reverse().find(e => time >= e.time);

            if (currentEvent) {
                // å›åˆåˆ‡æ› (Time-based fallback)
                // If we are significantly past the start time, ensure we are on the right round.
                // But if we just flipped early, we don't want to revert or re-trigger.
                // The Timeline 'round' property is authoritative.
                // If we flipped early, GAME_STATE.currentRound IS already nextRoundIdx.
                // So if currentEvent.round matches, good.
                // The tricky part: R1 ends at 8.0s. We flip to R2.
                // Current time is 8.5s. currentEvent is still R1 (timeline: 5.3s).
                // So currentEvent.round is 0. GAME_STATE.currentRound is 1.
                // If we execute: `if (currentEvent.round !== GAME_STATE.currentRound) setRound(currentEvent.round)`
                // It will SET IT BACK to 0!
                // FIX: We must Ignore Time-based round setting if we are in the "Early Flip" period.
                // OR: We only set round if the Beat Index is low (start of round)?

                if (currentEvent.action === 'start') {
                    // è¨ˆç®—è©²å›åˆå•Ÿå‹•å¾Œçš„ç¶“éæ™‚é–“
                    const elapsedTime = time - currentEvent.time;
                    const beatIndex = Math.floor(elapsedTime / BEAT_DURATION);

                    // Start of round sync (only if we are NOT in the finished state of PREVIOUS round, which is impossible if `currentEvent` changed)
                    // Logic: If beatIndex is < 8, we MUST be on `currentEvent.round`.
                    // If beatIndex >= 8, we MIGHT be on next round (Early Flip).

                    if (beatIndex < 8 && GAME_STATE.currentRound !== currentEvent.round) {
                        setRound(currentEvent.round);
                    }

                    // é‚è¼¯: æ¯ä¸€è¼ªåªé–ƒçˆ 8 æ¬¡ (0~7)
                    if (beatIndex < 8) {
                        GAME_STATE.hasFlippedForThisRound = false;

                        if (beatIndex !== GAME_STATE.lastBeat) {
                            GAME_STATE.lastBeat = beatIndex;
                            updateRhythmEffect(beatIndex);

                            // Pump Title
                            if (beatIndex % 2 === 0) { // å¼·æ‹
                                title.style.opacity = '1';
                                title.style.transform = 'scale(1.1)';
                            } else {
                                title.style.opacity = '0.7';
                                title.style.transform = 'scale(1)';
                            }
                        }
                    } else {
                        // è¶…é8æ‹ï¼Œåœæ­¢é–ƒçˆ
                        if (GAME_STATE.lastBeat !== -1) {
                            updateRhythmEffect(-1);
                            GAME_STATE.lastBeat = -1;
                            title.style.opacity = '0.5';
                            title.style.transform = 'scale(1)';

                            // --- EARLY SWITCH TRIGGER ---
                            const nextRoundIdx = currentEvent.round + 1;
                            // Ensure next round exists AND we haven't flipped yet
                            // Note: currentEvent.round comes from timeline.
                            if (nextRoundIdx < TOTAL_ROUNDS && !GAME_STATE.hasFlippedForThisRound) {
                                prepareFlipContent(nextRoundIdx);
                                // Flip immediately (no delay)
                                triggerFlip();
                                GAME_STATE.currentRound = nextRoundIdx;
                                updateRoundButtons();
                                GAME_STATE.hasFlippedForThisRound = true;
                            }
                        }
                    }
                } else {
                    updateRhythmEffect(-1);
                }
            } else {
                updateRhythmEffect(-1);
            }
        }

        function updateRhythmEffect(slotIndex) {
            document.querySelectorAll('.grid-item').forEach(el => el.classList.remove('active'));
            if (slotIndex !== -1) {
                const targetSlot = document.getElementById(`slot-${slotIndex}`);
                if (targetSlot) targetSlot.classList.add('active');
            }
        }

        document.getElementById('play-btn').addEventListener('click', () => {
            if (GAME_STATE.isPlaying) player.pauseVideo();
            else player.playVideo();
        });

        document.getElementById('reset-btn').addEventListener('click', () => {
            if (player && player.seekTo) {
                player.seekTo(0);
                player.pauseVideo();
                GAME_STATE.lastBeat = -1;
                setRound(0);
                updateRhythmEffect(-1);
                // document.getElementById('timer-display').innerText = "TIME: 0.00s";
            }
        });

        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        init();
    </script>
</body>

</html>
